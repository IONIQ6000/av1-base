#!/usr/bin/env bash
#
# av1an Docker wrapper
# Drop-in replacement that runs av1an via masterofzen/av1an:master
#
# This wrapper transparently maps paths so the daemon can call "av1an" 
# as if it were installed locally.

set -eo pipefail

IMAGE="masterofzen/av1an:master"

# If no arguments or just --version/--help, run without mounts
if [[ $# -eq 0 ]] || [[ "$1" == "--version" ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
    exec docker run --rm --privileged "${IMAGE}" "$@"
fi

# Track top-level directories we need to mount
declare -A MOUNT_DIRS

add_path() {
    local path="$1"
    
    # Make absolute if relative
    if [[ "${path}" != /* ]]; then
        path="$(pwd)/${path}"
    fi
    
    # Extract top-level directory (e.g., /main-library-2 from /main-library-2/Media/...)
    local top_dir="/$(echo "$path" | cut -d'/' -f2)"
    
    if [[ -n "$top_dir" ]] && [[ "$top_dir" != "/" ]] && [[ -d "$top_dir" ]]; then
        MOUNT_DIRS["$top_dir"]=1
    fi
}

# Parse arguments to find -i, -o, and --temp paths that need mounting
AV1AN_ARGS=()

i=1
while [[ $i -le $# ]]; do
    arg="${!i}"
    
    case "${arg}" in
        -i|--input)
            ((i++))
            if [[ $i -le $# ]]; then
                add_path "${!i}"
                AV1AN_ARGS+=("${arg}" "${!i}")
            fi
            ;;
        -o|--output)
            ((i++))
            if [[ $i -le $# ]]; then
                add_path "${!i}"
                AV1AN_ARGS+=("${arg}" "${!i}")
            fi
            ;;
        --temp)
            ((i++))
            if [[ $i -le $# ]]; then
                add_path "${!i}"
                AV1AN_ARGS+=("${arg}" "${!i}")
            fi
            ;;
        *)
            AV1AN_ARGS+=("${arg}")
            ;;
    esac
    ((i++))
done

# Build mount arguments
MOUNTS=()
for dir in "${!MOUNT_DIRS[@]}"; do
    mkdir -p "${dir}" 2>/dev/null || true
    MOUNTS+=("-v" "${dir}:${dir}")
done

# Also mount current working directory's top-level
cwd_top="/$(pwd | cut -d'/' -f2)"
if [[ -n "$cwd_top" ]] && [[ "$cwd_top" != "/" ]] && [[ -d "$cwd_top" ]]; then
    MOUNT_DIRS["$cwd_top"]=1
    MOUNTS+=("-v" "${cwd_top}:${cwd_top}")
fi

# Run av1an in Docker
exec docker run --rm \
    --privileged \
    --user 0:0 \
    "${MOUNTS[@]}" \
    -w "$(pwd)" \
    "${IMAGE}" \
    "${AV1AN_ARGS[@]}"
