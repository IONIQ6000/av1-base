#!/usr/bin/env bash
#
# ffprobe Docker wrapper
# Runs ffprobe via masterofzen/av1an:master container
#

set -eo pipefail

IMAGE="masterofzen/av1an:master"

# For simple commands like -version, run without mounts
if [[ $# -eq 0 ]] || [[ "$1" == "-version" ]] || [[ "$1" == "-help" ]] || [[ "$1" == "-h" ]]; then
    exec docker run --rm --privileged --entrypoint ffprobe "${IMAGE}" "$@"
fi

# For probing files, mount the top-level directory of any file paths
declare -A MOUNT_DIRS
ARGS=()

for arg in "$@"; do
    if [[ "$arg" == /* ]]; then
        # Extract top-level directory (e.g., /main-library-2 from /main-library-2/Media/...)
        top_dir="/$(echo "$arg" | cut -d'/' -f2)"
        if [[ -d "$top_dir" ]]; then
            MOUNT_DIRS["$top_dir"]=1
        fi
    fi
    ARGS+=("$arg")
done

# Build mount arguments
MOUNTS=()
for dir in "${!MOUNT_DIRS[@]}"; do
    MOUNTS+=("-v" "${dir}:${dir}")
done

# Also mount current working directory if not root
if [[ "$(pwd)" != "/" ]]; then
    MOUNTS+=("-v" "$(pwd):$(pwd)")
fi

exec docker run --rm \
    --privileged \
    --user 0:0 \
    --entrypoint ffprobe \
    "${MOUNTS[@]}" \
    -w "$(pwd)" \
    "${IMAGE}" \
    "${ARGS[@]}"
