#!/usr/bin/env bash
#
# ffprobe Docker wrapper
# Runs ffprobe via masterofzen/av1an:master container
#

set -eo pipefail

IMAGE="masterofzen/av1an:master"

# For simple commands like -version, run without mounts
if [[ $# -eq 0 ]] || [[ "$1" == "-version" ]] || [[ "$1" == "-help" ]] || [[ "$1" == "-h" ]]; then
    exec docker run --rm --privileged --entrypoint ffprobe "${IMAGE}" "$@"
fi

# For probing files, we need to mount the file's directory
# Find any file paths in arguments and mount their parent directories
declare -A MOUNT_DIRS
ARGS=()

for arg in "$@"; do
    if [[ -e "$arg" ]] || [[ "$arg" == /* ]]; then
        # This looks like a file path - mount its parent directory
        if [[ "$arg" == /* ]]; then
            dir=$(dirname "$arg")
        else
            dir=$(dirname "$(pwd)/$arg")
        fi
        # Skip root directory
        if [[ "$dir" != "/" ]]; then
            MOUNT_DIRS["$dir"]=1
        fi
    fi
    ARGS+=("$arg")
done

# Build mount arguments
MOUNTS=()
for dir in "${!MOUNT_DIRS[@]}"; do
    MOUNTS+=("-v" "${dir}:${dir}:ro")
done

# Mount the top-level directory for files at root
# e.g., /main-library-2 for /main-library-2/Media/...
for arg in "$@"; do
    if [[ "$arg" == /* ]]; then
        top_dir=$(echo "$arg" | cut -d'/' -f2)
        if [[ -n "$top_dir" ]] && [[ -d "/$top_dir" ]]; then
            MOUNT_DIRS["/$top_dir"]=1
        fi
    fi
done

# Rebuild mounts with top-level dirs
MOUNTS=()
for dir in "${!MOUNT_DIRS[@]}"; do
    MOUNTS+=("-v" "${dir}:${dir}:ro")
done

# Also mount current working directory if not root
if [[ "$(pwd)" != "/" ]]; then
    MOUNTS+=("-v" "$(pwd):$(pwd):ro")
fi

exec docker run --rm \
    --privileged \
    --entrypoint ffprobe \
    "${MOUNTS[@]}" \
    -w "$(pwd)" \
    "${IMAGE}" \
    "${ARGS[@]}"
